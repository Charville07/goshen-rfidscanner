#!/usr/bin/env node


var app = require('../app');
var debug = require('debug')('rfid:server');
var http = require('http');
var mysql = require('mysql');
var request = require('request');
var internetAvailable = require("internet-available");
var fs = require('fs');
var dns = require('dns');
const axios = require('axios');
const download = require('image-downloader');

var yyyymmdd = require('yyyy-mm-dd');
var con = mysql.createConnection({
  host: "localhost",
  user: "root",
  password: "raspberry",
  database: "rfid",
  multipleStatements: true
});

let options = [];

var schoolV = "mvc";
var faculty_phone = "09164812418";
var student_url = "https://mvc.bridgette.app/api/col_student_info/getstudentlist/";
var picture_url = "https://mvc.bridgette.app/uploads/col/students/";
var tap_loc = "pearl";
var tap_type = "dorm"; // tapping type = [church, worship, gate, dorm]
var tap_hostel_id = "2";

var RefreshPage;
var RefreshPageInterval = 180000;//180000;

var modalPage;
var modalPageInterval = 10000;//10000;
let modalPageTitle = "";
let modalPageMessage = "";

RefreshPage =  setTimeout(function() {
  return console.log("1st refresh page!");
}, 0);

con.connect(function(err) {
  if (err) {
    console.log('No Database Connection');
  }else{
    console.log('Database Connected');
  }
});

app.set('port', process.env.PORT || 8080);
var server = app.listen(app.get('port'), function(){
  debug('Express Server listening on port' + server.address().port);
});

var io = require('socket.io').listen(server);
io.sockets.on('connection', function (socket) {
    console.log('A client is connected!');
});


clearTimeout(RefreshPage);
RefreshPage =  setTimeout(function() {
  console.log("refresh page! :" + rfid);
  io.emit('statusC', ('hidden'));
}, RefreshPageInterval);

clearTimeout(modalPage);
modalPage =  setTimeout(function() {
  console.log("show modal page! :" + rfid);
  io.emit('myModal', ('show'));
  io.emit('modalTitle', (''));
  io.emit('myBanner', ('active'));
}, modalPageInterval);

internetAvailable({
  domainName: "mvc.bridgette.app",
  port: 53,
  host: '8.8.8.8'
}).then(() => {

  console.log("Internet available");
  
  for (var i = 1; i < 6; i++) {
    options = {
      url : "https://mvc.bridgette.app/uploads/school_posters/banner" + i + ".jpg",
      dest: './public/uploads/school_posters/' // Save to /path/to/dest/image.jpg
    }
  
    download.image(options)
      .then(({ filename, image }) => {
        console.log('Saved to', filename)  // Saved to /path/to/dest/image.jpg
    })
      .catch((err) => console.error(err))
  }

  var url = student_url;
  request({
      url: url,
      json: true
  }, function (error, response, jsondata) {
      if (!error && response.statusCode === 200) {
        console.log("Number of students: "+jsondata.length);
        var values = [];
        for(var i=0; i< jsondata.length; i++){
            // console.log(values);
            values.push([
                        jsondata[i].student_id,
                        jsondata[i].admission_no,
                        jsondata[i].program_short_name,
                        jsondata[i].program_name,
                        jsondata[i].major_in,
                        jsondata[i].firstname,
                        jsondata[i].middlename,
                        jsondata[i].lastname,
                        jsondata[i].image,
                        jsondata[i].guardian_phone,
                        jsondata[i].rfid_number,
                        jsondata[i].lunch_pass,
                        jsondata[i].commuter_pass,
                        jsondata[i].student_hostel_id,
                        jsondata[i].hostel_status,
                        jsondata[i].effective_sy,
                        jsondata[i].term_last_activated
                        
                        
                      ]);
          }
          con.query("truncate students"+";"+'INSERT INTO students (student_id, admission_no, program_short_name, program_name, major_in, firstname, middlename, lastname, image, guardian_phone, rfid_number, lunch_pass, commuter_pass, hostel_id, dormitory, effective_sy, term_last_activated) VALUES ?', [values], function(err,result) {
          if(err) {
            console.log('Update Student List Failed!');
          }else{
            console.log('Update Student List Success!');
          }
        });
      }

  });


  var url = "http://157.230.43.105/" + schoolV + "/ajax/getfacultyandstafflist";
  request({
      url: url,
      json: true
  }, function (error, response, jsondata) {
    if (!error && response.statusCode === 200) {
      console.log("Number of staffs: "+jsondata.length);
      var values = [];
      for(var i=0; i< jsondata.length; i++){
        values.push([
                    jsondata[i].id,
                    jsondata[i].user_id,
                    jsondata[i].firstname,
                    jsondata[i].middlename,
                    jsondata[i].lastname,
                    jsondata[i].phone,
                    jsondata[i].rfid_number,
                    jsondata[i].image,
                    jsondata[i].role
                  ]);
      }
      con.query("truncate staffs"+";"+'INSERT INTO staffs (id,user_id,firstname,middlename,lastname,phone,rfid_number,image,role) VALUES ?', [values], function(err,result) {
        if(err) {
          console.log('Update Staff List Failed!');
        }else {
          console.log('Update Staff List Success!');
        }
      });
    }

  });


}).catch(() => {
    console.log("No internet");
});

 

//---------------------------------------- SCANNER start --------------------------------------------------------------------
var rfid = '';
var sys   = require('util'),
    spawn = require('child_process').spawn,
    dummy  = spawn('python', ['input1.py']);
    dummy.stdout.on('data', function(data) {    
      rfid = (data.toString());
      rfid = rfid.slice(0, -1);

      dns.resolve('mvc.bridgette.app', function(err) {
          if (err) {
            console.log("No connection");
            io.emit('device_status', ('OFFLINE'));
          } else {
            console.log("Connected");
            io.emit('device_status', ('ONLINE'));
          }
        });

      console.log('Scanner 1 - IN');
      console.log(rfid);
      io.emit('myModal', ('hide'));
      io.emit('myBanner', ('hide'));
      //---------------------------------------- Query start -----------------------------------------------------------------------
      con.query("SELECT id FROM students WHERE rfid_number = " + rfid, function (err, studID, fields) {
        if (err) {console.log("scan error students");}else{
          con.query("SELECT id FROM staffs WHERE rfid_number = " + rfid, function (err, staffID, fields) {
            if (err) {console.log("scan error staff");}else{
              con.query("SELECT id FROM college_students WHERE rfid_number = " + rfid, function (err, colStudID, fields) {
                if (err) {console.log("scan error college");}else{
                  //--------------------------------------- IF Student RFID Found  start -------------------------------------------------------
                  if (studID.length > 0){
                    console.log('Student ID found');
                    con.query("SELECT * FROM students WHERE rfid_number = " + rfid, function (err, result, fields) {
                      if (err) {console.log("scan error student2");}else{

                        options = {
                          url : picture_url + result[0].image,
                          dest: './public/uploads/student_images/' // Save to /path/to/dest/image.jpg
                        }

                        download.image(options)
                          .then(({ filename, image }) => {
                            console.log('Saved to', filename)  // Saved to /path/to/dest/image.jpg
                        })
                          .catch((err) => console.error(err))

                          var today = new Date()
                          var curHr = today.getHours()
                          console.log('CHECKED IN!')

                          io.emit('message', (rfid));
                          io.emit('color', ('#ffffff'));
                          io.emit('firstname', (result[0].firstname));
                          io.emit('lastname', (result[0].lastname+'&ensp;'+result[0].middlename.charAt(0)));
                          io.emit('middlename', (result[0].middlename.charAt(0)));
                          io.emit('valid', ('visible'));

                          io.emit('admission_no', (result[0].admission_no));
                      
                          // if (result[0].major_in == null || result[0].major_in == '' || result[0].major_in == 'none' || result[0].major_in == 'None'){
                          //     io.emit('section', (result[0].program_name));
                          // }else{
                          //     io.emit('section', (result[0].program_name+'-'+result[0].major_in));
                          //   }
                            
                          io.emit('section', (result[0].program_short_name));

                          if (result[0].image == null || result[0].image == ''){
                              io.emit('studImage', ('/uploads/student_images/default.jpg'));
                          }
                          else{
                              io.emit('studImage', ('/uploads/student_images/' + result[0].image));
                          };

                          io.emit('status', ('CHECKED IN'));
                          console.log(rfid);
                          console.log('CHECKED IN');
                          console.log('Firstname: '+result[0].firstname);
                          console.log('Middlename: '+result[0].middlename.charAt(0));
                          console.log('Lastname: '+result[0].lastname);
                          console.log('Program Short Name: '+result[0].program_short_name);
                          console.log('Program: '+result[0].program_name);
                          console.log('Major: '+result[0].major_in);
                          console.log('ID No.: '+result[0].admission_no);
                          console.log('Image: '+result[0].image);
                      
                          var dateTime =  yyyymmdd.withTime();
                          var time = new Date();
                          request.post('http://157.230.43.105/smsgateway/sms/insertsmsque', 
                              {form:{ sms_number: result[0].guardian_phone, sms_msg: result[0].lastname+", "+result[0].firstname+" is IN school at "+(time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }))+". This is an Autogenerated SMS by Bridgette. Please do not reply.", date_created: dateTime, school_code: 'MVC', student_id: result[0].student_id , tapped_type: 'IN' }}, 
                              function(error, response, body){
                                  console.log(body);
                          });

                          var d = new Date(),
                          minutes = d.getMinutes().toString().length == 1 ? '0'+d.getMinutes() : d.getMinutes(),
                          hours = d.getHours().toString().length == 1 ? '0'+d.getHours() : d.getHours();

                          var dateTime =  yyyymmdd.withTime();
                          
                          time = hours+':'+minutes;

                          con.query("INSERT INTO student_log (student_id,type,time,date,status, tap_loc, tap_type, hostel_id) VALUES ('"+result[0].student_id+"','IN','"+time+"','"+dateTime+"','idle', '"+tap_loc+"', '"+tap_type+"', '" + tap_hostel_id + "')", function (err, update, fields) {
                            if (err) {console.log('Insert Student Log Failed!');
                            }else{console.log('Insert Student Log Success!');}
                          });

                          //send student tapping log

                          request.post('https://mvc.bridgette.app/api/col_student_info/insertstudentlog', 
                            {form:{ 
                              student_id: result[0].student_id , 
                              admission_no: result[0].admission_no , 
                              status: 'IN',
                              time: time, 
                              date: dateTime, 
                              tap_loc: tap_loc, 
                              tap_type: tap_type, 
                              hostel_id: tap_hostel_id
                            }}, 
                            function(error, response, body){
                                console.log(body);
                          });

                      }


                    });
                  }
                
                  else if (staffID.length > 0){
                    console.log('Staff ID found');
                    con.query("SELECT * FROM staffs WHERE rfid_number = " + rfid, function (err, result, fields) {
                      if (err) {console.log("scan error staff2");}else{
                          var today = new Date()
                          var curHr = today.getHours()
                      
                          var d = new Date(),
                          minutes = d.getMinutes().toString().length == 1 ? '0'+d.getMinutes() : d.getMinutes(),
                          hours = d.getHours().toString().length == 1 ? '0'+d.getHours() : d.getHours();

                          var dateTime =  yyyymmdd.withTime();
                          

                          // dateTime = d.getFullYear()+'-'+d.getDate()+'-'+d.getMonth()+' '+hours+':'+minutes
                          time = hours+':'+minutes;

                          io.emit('message', (rfid));
                          io.emit('color', ('#ffffff'));
                          io.emit('firstname', (result[0].firstname));
                          io.emit('lastname', (result[0].lastname+'&ensp;'+result[0].middlename.charAt(0)));
                          io.emit('middlename', (result[0].middlename.charAt(0)));
                          io.emit('valid', ('visible'));

                          io.emit('admission_no', (result[0].role.toUpperCase()));
                          io.emit('section', (''));

                          if (result[0].image == null || result[0].image == ''){
                                  io.emit('studImage', ('uploads/student_images/default.jpg'));
                          }else{
                              io.emit('studImage', (result[0].image));
                          };

                          io.emit('status', ('CHECKED IN'));

                          
                          request.post('http://157.230.43.105/' + schoolV + '/ajax/insertfacultydtr', 
                          {form:{ faculty_id: result[0].user_id, role: result[0].role, type: 'IN', time: time, date: dateTime}}, 
                              function(error, response, body){
                                  console.log(body);
                          });

                          var time = new Date();
                          request.post('http://157.230.43.105/smsgateway/sms/insertsmsque', 
                              {form:{ sms_number: faculty_phone, sms_msg: result[0].lastname+", "+result[0].firstname+" is IN school at "+(time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }))+". This is an Autogenerated SMS by Bridgette. Please do not reply.", date_created: dateTime, school_code: schoolV.toUpperCase(), role: result[0].role, student_id: result[0].user_id , tapped_type: 'IN' }}, 
                          function(error, response, body){
                                  console.log(body);
                          });

                          console.log('CHECKED IN');
                          console.log(result[0].role);
                          console.log(rfid);
                          console.log(result[0].firstname);
                          console.log(result[0].lastname+'&ensp;'+result[0].middlename.charAt(0));
                          console.log(result[0].middlename.charAt(0));
                          console.log(result[0].image);
                          console.log(dateTime);
                          console.log(time);

                      }


                    });
                  }
                  else{
                    console.log('Invalid RFID');
                      io.emit('firstname', (''));
                      io.emit('lastname', (''));
                      io.emit('admission_no', (''));
                      io.emit('class', (''));
                      io.emit('section', (''));
                      io.emit('studImage', ('uploads/student_images/default.jpg'));
                      io.emit('status', ('INVALID RFID'));
                      io.emit('invalid', ('hidden'));
                      io.emit('color', ('#ffffff'));
                  }
                  //----------------------------------------------Invalid RFID end--------------------------------------------------------------
                }
              });
            }
          });
        }
      });

      clearTimeout(RefreshPage);
      RefreshPage =  setTimeout(function() {
        console.log("refresh page! :" + rfid);
        io.emit('statusC', ('hidden'));
      }, RefreshPageInterval);

      clearTimeout(modalPage);
      modalPage =  setTimeout(function() {
        console.log("show modal page! :" + rfid);
        io.emit('myModal', ('show'));
        io.emit('modalTitle', (''));
        io.emit('myBanner', ('active'));
      }, modalPageInterval);
    });

//---------------------------------------------- Scanner End -----------------------------------------------------------------




//---------------------------------------- SCANNER start --------------------------------------------------------------------
var rfid = '';
var sys   = require('util'),
    spawn = require('child_process').spawn,
    dummy  = spawn('python', ['input2.py']);
    dummy.stdout.on('data', function(data) {    
      rfid = (data.toString());
      rfid = rfid.slice(0, -1);

      dns.resolve('mvc.bridgette.app', function(err) {
          if (err) {
            console.log("No connection");
            io.emit('device_status', ('OFFLINE'));
          } else {
            console.log("Connected");
            io.emit('device_status', ('ONLINE'));
          }
        });

      console.log('Scanner 2 - OUT');
      console.log(rfid);
      io.emit('myModal', ('hide'));
      io.emit('myBanner', ('hide'));
      //---------------------------------------- Query start -----------------------------------------------------------------------
      con.query("SELECT id FROM students WHERE rfid_number = " + rfid, function (err, studID, fields) {
        if (err) {console.log("scan error students");}else{
          con.query("SELECT id FROM staffs WHERE rfid_number = " + rfid, function (err, staffID, fields) {
            if (err) {console.log("scan error staff");}else{
              con.query("SELECT id FROM college_students WHERE rfid_number = " + rfid, function (err, colStudID, fields) {
                if (err) {console.log("scan error college");}else{
                  //--------------------------------------- IF Student RFID Found  start -------------------------------------------------------
                  if (studID.length > 0){
                    console.log('Student ID found');
                    con.query("SELECT * FROM students WHERE rfid_number = " + rfid, function (err, result, fields) {
                      if (err) {console.log("scan error student2");}else{

                          var today = new Date()
                          var curHr = today.getHours()
                          console.log('CHECKED OUT!')

                          io.emit('message', (rfid));
                          io.emit('color', ('#ffffff'));
                          io.emit('firstname', (result[0].firstname));
                          io.emit('lastname', (result[0].lastname+'&ensp;'+result[0].middlename.charAt(0)));
                          io.emit('middlename', (result[0].middlename.charAt(0)));
                          io.emit('valid', ('visible'));

                          io.emit('admission_no', (result[0].admission_no));
                      
                          // if (result[0].major_in == null || result[0].major_in == '' || result[0].major_in == 'none' || result[0].major_in == 'None'){
                          //     io.emit('section', (result[0].program_name));
                          //   }else{
                          //     io.emit('section', (result[0].program_name+'-'+result[0].major_in));
                          //   }
                            
                          io.emit('section', (result[0].program_short_name));

                          if (result[0].image == null || result[0].image == ''){
                              io.emit('studImage', ('/uploads/student_images/default.jpg'));
                          }
                          else{
                              io.emit('studImage', ('/uploads/student_images/' + result[0].image));
                          };

                          io.emit('status', ('CHECKED OUT'));
                          console.log(rfid);
                          console.log('CHECKED OUT');
                          console.log('Firstname: '+result[0].firstname);
                          console.log('Middlename: '+result[0].middlename.charAt(0));
                          console.log('Lastname: '+result[0].lastname);
                          console.log('Program Short Name: '+result[0].program_short_name);
                          console.log('Program: '+result[0].program_name);
                          console.log('Major: '+result[0].major_in);
                          console.log('ID No.: '+result[0].admission_no);
                          console.log('Image: '+result[0].image);
                      
                          var dateTime =  yyyymmdd.withTime();
                          var time = new Date();
                          request.post('http://157.230.43.105/smsgateway/sms/insertsmsque', 
                              {form:{ sms_number: result[0].guardian_phone, sms_msg: result[0].lastname+", "+result[0].firstname+" is OUT school at "+(time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }))+". This is an Autogenerated SMS by Bridgette. Please do not reply.", date_created: dateTime, school_code: 'MVC', student_id: result[0].student_id , tapped_type: 'OUT' }}, 
                              function(error, response, body){
                                  console.log(body);
                          });

                          var d = new Date(),
                          minutes = d.getMinutes().toString().length == 1 ? '0'+d.getMinutes() : d.getMinutes(),
                          hours = d.getHours().toString().length == 1 ? '0'+d.getHours() : d.getHours();

                          var dateTime =  yyyymmdd.withTime();
                          
                          time = hours+':'+minutes;

                          con.query("INSERT INTO student_log (student_id,type,time,date,status, tap_loc, tap_type, hostel_id) VALUES ('"+result[0].student_id+"','OUT','"+time+"','"+dateTime+"','idle', '"+tap_loc+"', '"+tap_type+"', '" + tap_hostel_id + "')", function (err, update, fields) {
                            if (err) {console.log('Insert Student Log Failed!');
                            }else{console.log('Insert Student Log Success!');}
                          });

                          //send student tapping log

                          request.post('https://mvc.bridgette.app/api/col_student_info/insertstudentlog', 
                            {form:{ 
                              student_id: result[0].student_id , 
                              admission_no: result[0].admission_no , 
                              status: 'OUT',
                              time: time, 
                              date: dateTime, 
                              tap_loc: tap_loc, 
                              tap_type: tap_type, 
                              hostel_id: tap_hostel_id
                            }}, 
                            function(error, response, body){
                                console.log(body);
                          });

                      }


                    });
                  }
                
                  else if (staffID.length > 0){
                    console.log('Staff ID found');
                    con.query("SELECT * FROM staffs WHERE rfid_number = " + rfid, function (err, result, fields) {
                      if (err) {console.log("scan error staff2");}else{
                          var today = new Date()
                          var curHr = today.getHours()
                      
                          var d = new Date(),
                          minutes = d.getMinutes().toString().length == 1 ? '0'+d.getMinutes() : d.getMinutes(),
                          hours = d.getHours().toString().length == 1 ? '0'+d.getHours() : d.getHours();

                          var dateTime =  yyyymmdd.withTime();
                          

                          // dateTime = d.getFullYear()+'-'+d.getDate()+'-'+d.getMonth()+' '+hours+':'+minutes
                          time = hours+':'+minutes;

                          io.emit('message', (rfid));
                          io.emit('color', ('#ffffff'));
                          io.emit('firstname', (result[0].firstname));
                          io.emit('lastname', (result[0].lastname+'&ensp;'+result[0].middlename.charAt(0)));
                          io.emit('middlename', (result[0].middlename.charAt(0)));
                          io.emit('valid', ('visible'));

                          io.emit('admission_no', (result[0].role.toUpperCase()));
                          io.emit('section', (''));

                          if (result[0].image == null || result[0].image == ''){
                                  io.emit('studImage', ('uploads/student_images/default.jpg'));
                          }else{
                              io.emit('studImage', (result[0].image));
                          };

                          io.emit('status', ('CHECKED OUT'));

                          
                          request.post('http://157.230.43.105/' + schoolV + '/ajax/insertfacultydtr', 
                          {form:{ faculty_id: result[0].user_id, role: result[0].role, type: 'OUT', time: time, date: dateTime}}, 
                              function(error, response, body){
                                  console.log(body);
                          });

                          var time = new Date();
                          request.post('http://157.230.43.105/smsgateway/sms/insertsmsque', 
                              {form:{ sms_number: faculty_phone, sms_msg: result[0].lastname+", "+result[0].firstname+" is OUT school at "+(time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }))+". This is an Autogenerated SMS by Bridgette. Please do not reply.", date_created: dateTime, school_code: schoolV.toUpperCase(), role: result[0].role, student_id: result[0].user_id , tapped_type: 'OUT' }}, 
                          function(error, response, body){
                                  console.log(body);
                          });

                          console.log('CHECKED OUT');
                          console.log(result[0].role);
                          console.log(rfid);
                          console.log(result[0].firstname);
                          console.log(result[0].lastname+'&ensp;'+result[0].middlename.charAt(0));
                          console.log(result[0].middlename.charAt(0));
                          console.log(result[0].image);
                          console.log(dateTime);
                          console.log(time);

                      }


                    });
                  }
                  else{
                    console.log('Invalid RFID');
                      io.emit('firstname', ('Loading...'));
                      io.emit('lastname', ('Loading...'));
                      io.emit('admission_no', ('Loading...'));
                      io.emit('class', ('Loading...'));
                      io.emit('section', ('Loading...'));
                      io.emit('studImage', ('uploads/student_images/default.jpg'));
                      io.emit('status', ('INVALID RFID'));
                      io.emit('invalid', ('hidden'));
                      io.emit('color', ('#ffffff'));
                  }
                  //----------------------------------------------Invalid RFID end--------------------------------------------------------------
                }
              });
            }
          });
        }
      });

      clearTimeout(RefreshPage);
      RefreshPage =  setTimeout(function() {
        console.log("refresh page! :" + rfid);
        io.emit('statusC', ('hidden'));
      }, RefreshPageInterval);

      clearTimeout(modalPage);
      modalPage =  setTimeout(function() {
        console.log("show modal page! :" + rfid);
        io.emit('myModal', ('show'));
        io.emit('modalTitle', (''));
        io.emit('myBanner', ('active'));
      }, modalPageInterval);
    });
//---------------------------------------------- Scanner End -----------------------------------------------------------------
